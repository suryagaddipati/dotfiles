#!/bin/bash

# git-wtc: Create a git worktree in .worktrees/branch_name

set -e

if [ $# -ne 1 ]; then
    echo "Usage: git wtc <branch_name>"
    echo "Creates a worktree in .worktrees/<branch_name>"
    exit 1
fi

branch_name="$1"

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "Error: Not in a git repository"
    exit 1
fi

# Get the repository root
repo_root=$(git rev-parse --show-toplevel)
worktree_path="$repo_root/.worktrees/$branch_name"

# Create .worktrees directory if it doesn't exist
mkdir -p "$repo_root/.worktrees"

# Check if worktree already exists
if [ -d "$worktree_path" ]; then
    echo "Error: Worktree .worktrees/$branch_name already exists"
    exit 1
fi

# Check if branch exists
if git show-ref --verify --quiet "refs/heads/$branch_name"; then
    # Branch exists, create worktree from existing branch
    echo "Creating worktree for existing branch '$branch_name'..."
    git worktree add "$worktree_path" "$branch_name"
else
    # Branch doesn't exist, create new branch and worktree
    echo "Creating new branch '$branch_name' and worktree..."
    git worktree add -b "$branch_name" "$worktree_path"
fi

echo "Worktree created at: $worktree_path"
echo "To switch to this worktree: cd $worktree_path"